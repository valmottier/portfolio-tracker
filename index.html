<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F0;
    --surface: #FFFFFF;
    --surface2: #F0EDE6;
    --border: #E2DDD4;
    --text: #1A1714;
    --text-secondary: #6B6560;
    --accent: #C4A35A;
    --accent-dark: #9E7E3A;
    --green: #2D7D4F;
    --green-bg: #EBF5F0;
    --red: #C0392B;
    --red-bg: #FDECEA;
    --blue: #2563EB;
    --blue-bg: #EFF6FF;
    --shadow: 0 2px 16px rgba(26,23,20,0.07);
    --shadow-lg: 0 8px 40px rgba(26,23,20,0.12);
    --radius: 14px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .logo span { color: var(--accent); }

  .nav-tabs {
    display: flex;
    gap: 4px;
  }

  .nav-tab {
    padding: 7px 18px;
    border-radius: 20px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-tab:hover { background: var(--surface2); color: var(--text); }
  .nav-tab.active { background: var(--text); color: white; }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .last-update {
    font-size: 12px;
    color: var(--text-secondary);
    font-family: 'DM Mono', monospace;
  }

  /* MAIN */
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* SETTINGS BANNER */
  .settings-banner {
    background: linear-gradient(135deg, #1A1714 0%, #2D2520 100%);
    color: white;
    border-radius: var(--radius);
    padding: 20px 28px;
    margin-bottom: 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .settings-banner.hidden { display: none; }

  .settings-banner p { font-size: 14px; opacity: 0.85; margin-top: 4px; }
  .settings-banner h3 { font-family: 'Playfair Display', serif; font-size: 18px; }

  .btn-configure {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.2s;
  }
  .btn-configure:hover { background: var(--accent-dark); }

  /* SUMMARY CARDS */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }

  .summary-card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 20px 24px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }

  .summary-card .label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  .summary-card .value {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--text);
  }

  .summary-card .sub {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  .summary-card .sub.green { color: var(--green); font-weight: 600; }
  .summary-card .sub.red { color: var(--red); font-weight: 600; }

  /* SECTION */
  .section {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    overflow: hidden;
  }

  .section-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title .icon { font-size: 18px; }

  .section-body { padding: 0; }

  /* TABLE */
  .asset-table {
    width: 100%;
    border-collapse: collapse;
  }

  .asset-table th {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-secondary);
    padding: 12px 20px;
    text-align: left;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }

  .asset-table td {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .asset-table tr:last-child td { border-bottom: none; }
  .asset-table tr:hover td { background: var(--surface2); }

  .asset-name {
    font-weight: 600;
    font-size: 15px;
  }

  .asset-type {
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .type-action { background: #EEF2FF; color: #4338CA; }
  .type-etf { background: #F0FDF4; color: #15803D; }
  .type-crypto { background: #FFF7ED; color: #C2410C; }
  .type-devise { background: #F0F9FF; color: #0369A1; }
  .type-matiere { background: #FDF4FF; color: #7E22CE; }

  .price-cell {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    font-weight: 500;
  }

  .change-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    padding: 3px 10px;
    border-radius: 12px;
  }

  .change-badge.positive { background: var(--green-bg); color: var(--green); }
  .change-badge.negative { background: var(--red-bg); color: var(--red); }
  .change-badge.neutral { background: var(--surface2); color: var(--text-secondary); }

  .pnl-cell { font-family: 'DM Mono', monospace; font-size: 13px; }
  .pnl-cell.positive { color: var(--green); font-weight: 600; }
  .pnl-cell.negative { color: var(--red); font-weight: 600; }

  /* BUTTONS */
  .btn {
    padding: 9px 20px;
    border-radius: 20px;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary { background: var(--text); color: white; }
  .btn-primary:hover { background: #333; }

  .btn-accent { background: var(--accent); color: white; }
  .btn-accent:hover { background: var(--accent-dark); }

  .btn-outline {
    background: transparent;
    color: var(--text);
    border: 1.5px solid var(--border);
  }
  .btn-outline:hover { border-color: var(--text); }

  .btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    padding: 6px 10px;
  }
  .btn-ghost:hover { color: var(--red); background: var(--red-bg); }

  .btn-sm { padding: 6px 14px; font-size: 12px; }

  /* AI SECTION */
  .ai-header {
    background: linear-gradient(135deg, #1A1714 0%, #2D2520 100%);
    color: white;
    padding: 24px 28px;
    border-radius: var(--radius) var(--radius) 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .ai-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .ai-subtitle { font-size: 13px; opacity: 0.7; margin-top: 4px; }

  .btn-analyze {
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 24px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-analyze:hover { background: var(--accent-dark); transform: translateY(-1px); }
  .btn-analyze:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  .ai-body { padding: 24px 28px; }

  .ai-result {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 20px;
    font-size: 14px;
    line-height: 1.8;
    color: var(--text);
    white-space: pre-wrap;
    min-height: 80px;
  }

  .ai-result.placeholder { color: var(--text-secondary); font-style: italic; }

  .ai-question-row {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .ai-question-input {
    flex: 1;
    padding: 12px 18px;
    border: 1.5px solid var(--border);
    border-radius: 24px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
  }

  .ai-question-input:focus { border-color: var(--accent); }
  .ai-question-input::placeholder { color: var(--text-secondary); }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,23,20,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    backdrop-filter: blur(3px);
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 32px;
    width: 100%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: translateY(16px) scale(0.97); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal h2 {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    margin-bottom: 24px;
    color: var(--text);
  }

  .form-group { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.7px;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }

  .form-input, .form-select {
    width: 100%;
    padding: 11px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
  }

  .form-input:focus, .form-select:focus { border-color: var(--accent); }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  /* LOADING */
  .loading-dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
  }

  .loading-dots span {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: dot 1.2s infinite;
  }

  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dot {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
  }

  /* SETTINGS PAGE */
  .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 700px) {
    .settings-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .nav-tabs { display: none; }
    .summary-row { grid-template-columns: 1fr 1fr; }
  }

  .settings-section {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 24px;
  }

  .settings-section h3 {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .api-key-field {
    position: relative;
  }

  .api-key-field input {
    padding-right: 44px;
  }

  .toggle-visibility {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 16px;
    padding: 4px;
  }

  .save-banner {
    background: var(--green-bg);
    color: var(--green);
    padding: 12px 18px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    margin-top: 16px;
    display: none;
    align-items: center;
    gap: 8px;
  }

  .save-banner.visible { display: flex; }

  /* WATCHLIST empty */
  .empty-state {
    padding: 40px;
    text-align: center;
    color: var(--text-secondary);
  }

  .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* GEMS */
  .gems-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    padding: 20px;
  }

  .gem-card {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 18px;
    border: 1px solid var(--border);
  }

  .gem-symbol {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
  }

  .gem-name { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
  .gem-reason { font-size: 13px; margin-top: 10px; line-height: 1.6; color: var(--text); }

  /* SPINNER */
  .spinner {
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* History */
  .history-item {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }

  .history-item:last-child { border-bottom: none; }
  .history-item .h-date { color: var(--text-secondary); font-size: 11px; font-family: 'DM Mono', monospace; margin-bottom: 4px; }
  .history-item .h-q { font-weight: 600; margin-bottom: 6px; }
  .history-item .h-a { color: var(--text); line-height: 1.6; white-space: pre-wrap; }
</style>
</head>
<body>

<header>
  <div class="logo">Portfolio<span>.</span></div>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard')">Tableau de bord</button>
    <button class="nav-tab" onclick="showPage('watchlist')">Sous la loupe</button>
    <button class="nav-tab" onclick="showPage('ai')">Analyse IA</button>
    <button class="nav-tab" onclick="showPage('settings')">Param√®tres</button>
  </nav>
  <div class="header-right">
    <span class="last-update" id="lastUpdate">Chargement des taux‚Ä¶</span>
    <button class="btn btn-outline btn-sm" onclick="refreshPrices()">‚Üª Actualiser</button>
  </div>
</header>

<main>

  <!-- SETTINGS BANNER -->
  <div class="settings-banner" id="settingsBanner">
    <div>
      <h3>‚öôÔ∏è Configuration requise</h3>
      <p>Renseigne tes cl√©s API Finnhub et Anthropic pour activer toutes les fonctionnalit√©s.</p>
    </div>
    <button class="btn-configure" onclick="showPage('settings')">Configurer ‚Üí</button>
  </div>

  <!-- DASHBOARD PAGE -->
  <div class="page active" id="page-dashboard">

    <div class="summary-row" id="summaryRow">
      <div class="summary-card">
        <div class="label">Valeur totale</div>
        <div class="value" id="totalValue">‚Äî CHF</div>
        <div class="sub" id="totalPnl">Chargement‚Ä¶</div>
      </div>
      <div class="summary-card">
        <div class="label">Positions</div>
        <div class="value" id="totalPositions">0</div>
        <div class="sub">actifs en portefeuille</div>
      </div>
      <div class="summary-card">
        <div class="label">Meilleure perf.</div>
        <div class="value" id="bestPerf">‚Äî</div>
        <div class="sub green" id="bestPerfVal">‚Äî</div>
      </div>
      <div class="summary-card">
        <div class="label">Pire perf.</div>
        <div class="value" id="worstPerf">‚Äî</div>
        <div class="sub red" id="worstPerfVal">‚Äî</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title"><span class="icon">üíº</span> Mon Portefeuille</div>
        <button class="btn btn-primary btn-sm" onclick="openModal('portfolio')">+ Ajouter</button>
      </div>
      <div class="section-body">
        <table class="asset-table">
          <thead>
            <tr>
              <th>Actif</th>
              <th>Type</th>
              <th>Quantit√©</th>
              <th>Prix achat moy.</th>
              <th>Prix actuel</th>
              <th>Variation 24h</th>
              <th>+/- Latent</th>
              <th>Valeur</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="portfolioTable">
            <tr><td colspan="9"><div class="empty-state"><div class="icon">üì≠</div><p>Aucun actif. Clique sur "+ Ajouter" pour commencer.</p></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- WATCHLIST PAGE -->
  <div class="page" id="page-watchlist">
    <div class="section">
      <div class="section-header">
        <div class="section-title"><span class="icon">üîç</span> Sous la Loupe</div>
        <button class="btn btn-primary btn-sm" onclick="openModal('watchlist')">+ Ajouter</button>
      </div>
      <div class="section-body">
        <table class="asset-table">
          <thead>
            <tr>
              <th>Actif</th>
              <th>Type</th>
              <th>Prix actuel</th>
              <th>Variation 24h</th>
              <th>Raison de suivi</th>
              <th>Ajout√© le</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="watchlistTable">
            <tr><td colspan="7"><div class="empty-state"><div class="icon">üî≠</div><p>Aucun actif sous surveillance.</p></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- AI PAGE -->
  <div class="page" id="page-ai">
    <div class="section">
      <div class="ai-header">
        <div>
          <div class="ai-title">‚ú¶ Analyse IA</div>
          <div class="ai-subtitle">Conseils personnalis√©s bas√©s sur ton portefeuille et profil investisseur</div>
        </div>
        <button class="btn-analyze" id="analyzeBtn" onclick="runAnalysis()">
          <span>Lancer l'analyse</span>
        </button>
      </div>
      <div class="ai-body">
        <div class="ai-result placeholder" id="aiResult">
          Lance une analyse pour obtenir des recommandations personnalis√©es sur ton portefeuille‚Ä¶
        </div>

        <div class="ai-question-row" style="margin-top:24px;">
          <input type="text" class="ai-question-input" id="aiQuestion" placeholder="Pose une question‚Ä¶ ex: J'ai 300 CHF √† investir ce mois-ci, que me conseilles-tu ?" onkeydown="if(event.key==='Enter') askQuestion()">
          <button class="btn btn-accent" onclick="askQuestion()">Envoyer</button>
        </div>
      </div>
    </div>

    <!-- GEMS -->
    <div class="section" id="gemsSection" style="display:none;">
      <div class="section-header">
        <div class="section-title"><span class="icon">üíé</span> P√©pites du moment</div>
      </div>
      <div class="gems-grid" id="gemsGrid"></div>
    </div>

    <!-- HISTORY -->
    <div class="section" id="historySection" style="display:none;">
      <div class="section-header">
        <div class="section-title"><span class="icon">üïí</span> Historique des questions</div>
        <button class="btn btn-ghost btn-sm" onclick="clearHistory()">Effacer</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="settings-grid">

      <div class="settings-section">
        <h3>üîë Cl√©s API</h3>
        <div class="form-group">
          <label class="form-label">Cl√© API Finnhub</label>
          <div class="api-key-field">
            <input type="password" class="form-input" id="finnhubKey" placeholder="cq1abc123...">
            <button class="toggle-visibility" onclick="toggleVis('finnhubKey')">üëÅ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Cl√© API Anthropic (Claude)</label>
          <div class="api-key-field">
            <input type="password" class="form-input" id="anthropicKey" placeholder="sk-ant-...">
            <button class="toggle-visibility" onclick="toggleVis('anthropicKey')">üëÅ</button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveKeys()">Sauvegarder les cl√©s</button>
        <div class="save-banner" id="keysBanner">‚úì Cl√©s sauvegard√©es</div>
      </div>

      <div class="settings-section">
        <h3>üë§ Profil Investisseur</h3>
        <div class="form-group">
          <label class="form-label">Devise principale</label>
          <select class="form-select" id="currency">
            <option value="CHF" selected>CHF ‚Äì Franc suisse</option>
            <option value="EUR">EUR ‚Äì Euro</option>
            <option value="USD">USD ‚Äì Dollar</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Profil de risque</label>
          <select class="form-select" id="riskProfile">
            <option value="prudent">Prudent</option>
            <option value="equilibre" selected>√âquilibr√©</option>
            <option value="dynamique">Dynamique</option>
            <option value="agressif">Tr√®s agressif</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Budget mensuel √† investir (CHF)</label>
          <input type="number" class="form-input" id="monthlyBudget" placeholder="300">
        </div>
        <div class="form-group">
          <label class="form-label">Horizon d'investissement</label>
          <select class="form-select" id="horizon">
            <option value="court">Court terme (< 1 an)</option>
            <option value="moyen">Moyen terme (1‚Äì5 ans)</option>
            <option value="long" selected>Long terme (5+ ans)</option>
          </select>
        </div>
      </div>

      <div class="settings-section">
        <h3>üè¶ Courtier & Frais</h3>
        <div class="form-group">
          <label class="form-label">Courtier</label>
          <input type="text" class="form-input" id="broker" value="UBS">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Frais fixes / transaction (CHF)</label>
            <input type="number" class="form-input" id="fixedFees" placeholder="9">
          </div>
          <div class="form-group">
            <label class="form-label">Frais variables (%)</label>
            <input type="number" class="form-input" id="varFees" placeholder="0.5" step="0.1">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Frais de change (%)</label>
          <input type="number" class="form-input" id="fxFees" placeholder="1.5" step="0.1">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">Sauvegarder le profil</button>
        <div class="save-banner" id="profileBanner">‚úì Profil sauvegard√©</div>
      </div>

      <div class="settings-section">
        <h3>üéØ Strat√©gie</h3>
        <div class="form-group">
          <label class="form-label">Objectif principal</label>
          <select class="form-select" id="objective">
            <option value="croissance">Croissance du capital</option>
            <option value="revenus">Revenus passifs / dividendes</option>
            <option value="retraite">Pr√©paration retraite</option>
            <option value="mixte" selected>Mixte</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Secteurs √† favoriser</label>
          <input type="text" class="form-input" id="favSectors" placeholder="ex: tech, sant√©, √©nergie">
        </div>
        <div class="form-group">
          <label class="form-label">Secteurs √† √©viter</label>
          <input type="text" class="form-input" id="avoidSectors" placeholder="ex: armement, tabac">
        </div>
        <div class="form-group">
          <label class="form-label">Alerte perte maximale (%)</label>
          <input type="number" class="form-input" id="stopLoss" placeholder="15">
        </div>
        <button class="btn btn-primary" onclick="saveStrategy()">Sauvegarder la strat√©gie</button>
        <div class="save-banner" id="strategyBanner">‚úì Strat√©gie sauvegard√©e</div>
      </div>

    </div>
  </div>

</main>

<!-- MODAL PORTEFEUILLE -->
<div class="modal-overlay" id="modal-portfolio">
  <div class="modal">
    <h2>‚ûï Ajouter un actif</h2>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Symbole / Ticker</label>
        <input type="text" class="form-input" id="p-symbol" placeholder="ex: AAPL, BTC, EURUSD" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="form-group">
        <label class="form-label">Type d'actif</label>
        <select class="form-select" id="p-type">
          <option value="action">Action</option>
          <option value="etf">ETF</option>
          <option value="crypto">Crypto</option>
          <option value="devise">Devise / Forex</option>
          <option value="matiere">Mati√®re premi√®re</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Nom complet (optionnel)</label>
      <input type="text" class="form-input" id="p-name" placeholder="ex: Apple Inc.">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Quantit√©</label>
        <input type="number" class="form-input" id="p-qty" placeholder="10" step="any">
      </div>
      <div class="form-group">
        <label class="form-label">Prix d'achat moyen (CHF)</label>
        <input type="number" class="form-input" id="p-buyPrice" placeholder="175.50" step="any">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Date d'achat</label>
      <input type="date" class="form-input" id="p-date">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('portfolio')">Annuler</button>
      <button class="btn btn-primary" onclick="addToPortfolio()">Ajouter</button>
    </div>
  </div>
</div>

<!-- MODAL WATCHLIST -->
<div class="modal-overlay" id="modal-watchlist">
  <div class="modal">
    <h2>üîç Ajouter √† la surveillance</h2>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Symbole / Ticker</label>
        <input type="text" class="form-input" id="w-symbol" placeholder="ex: MSFT" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="form-group">
        <label class="form-label">Type d'actif</label>
        <select class="form-select" id="w-type">
          <option value="action">Action</option>
          <option value="etf">ETF</option>
          <option value="crypto">Crypto</option>
          <option value="devise">Devise / Forex</option>
          <option value="matiere">Mati√®re premi√®re</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Nom complet (optionnel)</label>
      <input type="text" class="form-input" id="w-name" placeholder="ex: Microsoft Corp.">
    </div>
    <div class="form-group">
      <label class="form-label">Raison de suivi</label>
      <input type="text" class="form-input" id="w-reason" placeholder="ex: IA, cloud, forte croissance‚Ä¶">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('watchlist')">Annuler</button>
      <button class="btn btn-primary" onclick="addToWatchlist()">Ajouter</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let portfolio = [];
let watchlist = [];
let history = [];
let prices = {};
let fxRates = { USDCHF: 1, EURCHF: 1 };

// ============================================================
// STOCKAGE PERSISTANT (synchronise sur tous tes appareils)
// ============================================================
async function saveData(key, value) {
  try {
    await window.storage.set(key, JSON.stringify(value), false);
  } catch(e) {
    console.warn('Erreur sauvegarde:', e);
  }
}

async function loadData(key) {
  try {
    const result = await window.storage.get(key, false);
    return result ? JSON.parse(result.value) : null;
  } catch(e) {
    return null;
  }
}

async function loadAllData() {
  const [p, w, h, c] = await Promise.all([
    loadData('portfolio'),
    loadData('watchlist'),
    loadData('aiHistory'),
    loadData('config')
  ]);
  if (p) portfolio = p;
  if (w) watchlist = w;
  if (h) history = h;
  if (c) _config = c;
}

let _config = {};

function getConfig() {
  return {
    finnhubKey: _config.finnhubKey || '',
    anthropicKey: _config.anthropicKey || '',
    currency: _config.currency || 'CHF',
    riskProfile: _config.riskProfile || 'equilibre',
    monthlyBudget: _config.monthlyBudget || '300',
    horizon: _config.horizon || 'long',
    broker: _config.broker || 'UBS',
    fixedFees: _config.fixedFees || '9',
    varFees: _config.varFees || '0.5',
    fxFees: _config.fxFees || '1.5',
    objective: _config.objective || 'mixte',
    favSectors: _config.favSectors || '',
    avoidSectors: _config.avoidSectors || '',
    stopLoss: _config.stopLoss || '15',
  };
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const tabs = document.querySelectorAll('.nav-tab');
  const idx = ['dashboard','watchlist','ai','settings'].indexOf(name);
  if (idx >= 0) tabs[idx].classList.add('active');
}

// ============================================================
// SETTINGS
// ============================================================
function loadSettingsForm() {
  const c = getConfig();
  document.getElementById('finnhubKey').value = c.finnhubKey;
  document.getElementById('anthropicKey').value = c.anthropicKey;
  document.getElementById('currency').value = c.currency;
  document.getElementById('riskProfile').value = c.riskProfile;
  document.getElementById('monthlyBudget').value = c.monthlyBudget;
  document.getElementById('horizon').value = c.horizon;
  document.getElementById('broker').value = c.broker;
  document.getElementById('fixedFees').value = c.fixedFees;
  document.getElementById('varFees').value = c.varFees;
  document.getElementById('fxFees').value = c.fxFees;
  document.getElementById('objective').value = c.objective;
  document.getElementById('favSectors').value = c.favSectors;
  document.getElementById('avoidSectors').value = c.avoidSectors;
  document.getElementById('stopLoss').value = c.stopLoss;
}

function saveKeys() {
  const config = getConfig();
  config.finnhubKey = document.getElementById('finnhubKey').value.trim();
  config.anthropicKey = document.getElementById('anthropicKey').value.trim();
  saveData('config', config);
  showBanner('keysBanner');
  checkSettingsBanner();
}

function saveProfile() {
  const config = getConfig();
  ['currency','riskProfile','monthlyBudget','horizon','broker','fixedFees','varFees','fxFees'].forEach(k => {
    config[k] = document.getElementById(k).value;
  });
  saveData('config', config);
  showBanner('profileBanner');
}

function saveStrategy() {
  const config = getConfig();
  ['objective','favSectors','avoidSectors','stopLoss'].forEach(k => {
    config[k] = document.getElementById(k).value;
  });
  saveData('config', config);
  showBanner('strategyBanner');
}

function showBanner(id) {
  const b = document.getElementById(id);
  b.classList.add('visible');
  setTimeout(() => b.classList.remove('visible'), 2500);
}

function toggleVis(id) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

function checkSettingsBanner() {
  const c = getConfig();
  const banner = document.getElementById('settingsBanner');
  if (c.finnhubKey && c.anthropicKey) {
    banner.classList.add('hidden');
  } else {
    banner.classList.remove('hidden');
  }
}

// ============================================================
// MODALS
// ============================================================
function openModal(type) {
  document.getElementById('modal-' + type).classList.add('active');
  if (type === 'portfolio') document.getElementById('p-date').value = new Date().toISOString().split('T')[0];
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

// ============================================================
// PORTFOLIO
// ============================================================
function addToPortfolio() {
  const symbol = document.getElementById('p-symbol').value.trim();
  const type = document.getElementById('p-type').value;
  const name = document.getElementById('p-name').value.trim() || symbol;
  const qty = parseFloat(document.getElementById('p-qty').value);
  const buyPrice = parseFloat(document.getElementById('p-buyPrice').value);
  const date = document.getElementById('p-date').value;

  if (!symbol || isNaN(qty) || isNaN(buyPrice)) {
    alert('Veuillez remplir tous les champs obligatoires.');
    return;
  }

  const existing = portfolio.find(a => a.symbol === symbol);
  if (existing) {
    const totalQty = existing.qty + qty;
    existing.buyPrice = ((existing.buyPrice * existing.qty) + (buyPrice * qty)) / totalQty;
    existing.qty = totalQty;
  } else {
    portfolio.push({ symbol, type, name, qty, buyPrice, date, id: Date.now() });
  }

  savePortfolio();
  closeModal('portfolio');
  renderPortfolio();
  fetchPricesFor([symbol]);

  ['p-symbol','p-name','p-qty','p-buyPrice'].forEach(id => document.getElementById(id).value = '');
}

function removeFromPortfolio(id) {
  if (!confirm('Supprimer cet actif du portefeuille ?')) return;
  portfolio = portfolio.filter(a => a.id !== id);
  savePortfolio();
  renderPortfolio();
  updateSummary();
}

function savePortfolio() {
  saveData('portfolio', portfolio);
}

function renderPortfolio() {
  const tbody = document.getElementById('portfolioTable');
  if (portfolio.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="icon">üì≠</div><p>Aucun actif. Clique sur "+ Ajouter" pour commencer.</p></div></td></tr>';
    return;
  }

  tbody.innerHTML = portfolio.map(asset => {
    const price = prices[asset.symbol];
    const currentPriceRaw = price ? price.c : null;
    const currentPrice = currentPriceRaw ? getPriceInCHF(asset.symbol, currentPriceRaw) : null;
    const change = price ? price.dp : null;
    const value = currentPrice ? currentPrice * asset.qty : null;
    const pnl = currentPrice ? (currentPrice - asset.buyPrice) * asset.qty : null;
    const pnlPct = currentPrice ? ((currentPrice - asset.buyPrice) / asset.buyPrice) * 100 : null;

    const changeHTML = change !== null
      ? `<span class="change-badge ${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%</span>`
      : '<span class="change-badge neutral">‚Äî</span>';

    const pnlHTML = pnl !== null
      ? `<span class="pnl-cell ${pnl >= 0 ? 'positive' : 'negative'}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} CHF<br><small>${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</small></span>`
      : '<span class="pnl-cell">‚Äî</span>';

    return `
      <tr>
        <td><div class="asset-name">${asset.symbol}</div><div style="font-size:12px;color:var(--text-secondary)">${asset.name}</div></td>
        <td><span class="asset-type type-${asset.type}">${asset.type}</span></td>
        <td class="price-cell">${asset.qty}</td>
        <td class="price-cell">${asset.buyPrice.toFixed(2)} CHF</td>
        <td class="price-cell">${currentPrice ? currentPrice.toFixed(2) + ' CHF' : '<span style="color:var(--text-secondary)">‚Äî</span>'}</td>
        <td>${changeHTML}</td>
        <td>${pnlHTML}</td>
        <td class="price-cell">${value ? value.toFixed(2) + ' CHF' : '‚Äî'}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="removeFromPortfolio(${asset.id})">‚úï</button></td>
      </tr>
    `;
  }).join('');

  updateSummary();
}

// ============================================================
// WATCHLIST
// ============================================================
function addToWatchlist() {
  const symbol = document.getElementById('w-symbol').value.trim();
  const type = document.getElementById('w-type').value;
  const name = document.getElementById('w-name').value.trim() || symbol;
  const reason = document.getElementById('w-reason').value.trim();

  if (!symbol) { alert('Veuillez entrer un symbole.'); return; }
  if (watchlist.find(a => a.symbol === symbol)) { alert('Cet actif est d√©j√† dans ta liste de surveillance.'); return; }

  watchlist.push({ symbol, type, name, reason, date: new Date().toLocaleDateString('fr-CH'), id: Date.now() });
  saveWatchlist();
  closeModal('watchlist');
  renderWatchlist();
  fetchPricesFor([symbol]);

  ['w-symbol','w-name','w-reason'].forEach(id => document.getElementById(id).value = '');
}

function removeFromWatchlist(id) {
  watchlist = watchlist.filter(a => a.id !== id);
  saveWatchlist();
  renderWatchlist();
}

function saveWatchlist() {
  saveData('watchlist', watchlist);
}

function renderWatchlist() {
  const tbody = document.getElementById('watchlistTable');
  if (watchlist.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üî≠</div><p>Aucun actif sous surveillance.</p></div></td></tr>';
    return;
  }

  tbody.innerHTML = watchlist.map(asset => {
    const price = prices[asset.symbol];
    const currentPriceRaw = price ? price.c : null;
    const currentPrice = currentPriceRaw ? getPriceInCHF(asset.symbol, currentPriceRaw) : null;
    const change = price ? price.dp : null;

    const changeHTML = change !== null
      ? `<span class="change-badge ${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%</span>`
      : '<span class="change-badge neutral">‚Äî</span>';

    return `
      <tr>
        <td><div class="asset-name">${asset.symbol}</div><div style="font-size:12px;color:var(--text-secondary)">${asset.name}</div></td>
        <td><span class="asset-type type-${asset.type}">${asset.type}</span></td>
        <td class="price-cell">${currentPrice ? currentPrice.toFixed(2) + ' CHF' : '‚Äî'}</td>
        <td>${changeHTML}</td>
        <td style="font-size:13px;color:var(--text-secondary)">${asset.reason || '‚Äî'}</td>
        <td style="font-size:12px;color:var(--text-secondary);font-family:'DM Mono',monospace">${asset.date}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="removeFromWatchlist(${asset.id})">‚úï</button></td>
      </tr>
    `;
  }).join('');
}

// ============================================================
// PRICES (Finnhub)
// ============================================================
async function fetchPricesFor(symbols) {
  const { finnhubKey } = getConfig();
  if (!finnhubKey) return;

  for (const symbol of symbols) {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubKey}`);
      const data = await res.json();
      if (data.c && data.c > 0) {
        prices[symbol] = data;
      }
    } catch (e) { console.warn('Prix non disponible pour', symbol); }
  }

  renderPortfolio();
  renderWatchlist();
  document.getElementById('lastUpdate').textContent = 'Mis √† jour ' + new Date().toLocaleTimeString('fr-CH', {hour:'2-digit',minute:'2-digit'});
}

async function fetchFxRates() {
  try {
    // exchangerate-api.com ‚Äî gratuit, 1500 requ√™tes/mois, aucune cl√© requise pour USD
    const res = await fetch(`https://open.er-api.com/v6/latest/USD`);
    const data = await res.json();
    console.log('FX data re√ßu:', data);

    if (data.rates) {
      if (data.rates.CHF && data.rates.CHF > 0) fxRates.USDCHF = data.rates.CHF;
      if (data.rates.EUR && data.rates.CHF && data.rates.EUR > 0) {
        fxRates.EURCHF = data.rates.CHF / data.rates.EUR;
      }
      console.log('Taux mis √† jour ‚Äî USDCHF:', fxRates.USDCHF, 'EURCHF:', fxRates.EURCHF);
    } else {
      console.warn('Pas de rates dans la r√©ponse:', data);
    }

    document.getElementById('lastUpdate').textContent =
      `1 USD = ${fxRates.USDCHF.toFixed(4)} CHF ¬∑ Mis √† jour ${new Date().toLocaleTimeString('fr-CH', {hour:'2-digit',minute:'2-digit'})}`;
  } catch(e) {
    console.error('Erreur taux de change:', e);
    document.getElementById('lastUpdate').textContent = 'Taux indisponible';
  }
}

// D√©termine si un symbole est en USD et doit √™tre converti
function getPriceInCHF(symbol, priceUSD) {
  const asset = [...portfolio, ...watchlist].find(a => a.symbol === symbol);
  if (!asset) return priceUSD;
  // Les cryptos et actions US sont en USD ‚Üí conversion
  if (asset.type === 'crypto') return priceUSD * fxRates.USDCHF;
  if (asset.type === 'action' && !symbol.includes('.')) return priceUSD * fxRates.USDCHF; // actions sans suffixe = US
  return priceUSD; // ETF europ√©ens, mati√®res premi√®res, forex ‚Üí on garde tel quel
}

async function refreshPrices() {
  await fetchFxRates();
  const allSymbols = [...new Set([...portfolio.map(a => a.symbol), ...watchlist.map(a => a.symbol)])];
  if (allSymbols.length > 0) await fetchPricesFor(allSymbols);
}

// ============================================================
// SUMMARY
// ============================================================
function updateSummary() {
  const valued = portfolio.filter(a => prices[a.symbol] && prices[a.symbol].c > 0);

  const totalValue = valued.reduce((sum, a) => sum + getPriceInCHF(a.symbol, prices[a.symbol].c) * a.qty, 0);
  const totalCost = valued.reduce((sum, a) => sum + a.buyPrice * a.qty, 0);
  const totalPnl = totalValue - totalCost;
  const totalPnlPct = totalCost > 0 ? (totalPnl / totalCost) * 100 : 0;

  document.getElementById('totalValue').textContent = totalValue > 0 ? totalValue.toFixed(2) + ' CHF' : '‚Äî CHF';
  document.getElementById('totalPositions').textContent = portfolio.length;

  const pnlEl = document.getElementById('totalPnl');
  if (totalCost > 0) {
    pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} CHF (${totalPnlPct >= 0 ? '+' : ''}${totalPnlPct.toFixed(2)}%)`;
    pnlEl.className = 'sub ' + (totalPnl >= 0 ? 'green' : 'red');
  }

  const perfs = valued.map(a => {
    const currentPrice = getPriceInCHF(a.symbol, prices[a.symbol].c);
    const pnlPct = ((currentPrice - a.buyPrice) / a.buyPrice) * 100;
    return { symbol: a.symbol, pct: pnlPct };
  });

  if (perfs.length > 0) {
    perfs.sort((a, b) => b.pct - a.pct);
    const best = perfs[0], worst = perfs[perfs.length - 1];
    document.getElementById('bestPerf').textContent = best.symbol;
    document.getElementById('bestPerfVal').textContent = `${best.pct >= 0 ? '+' : ''}${best.pct.toFixed(2)}%`;
    document.getElementById('worstPerf').textContent = worst.symbol;
    document.getElementById('worstPerfVal').textContent = `${worst.pct >= 0 ? '+' : ''}${worst.pct.toFixed(2)}%`;
  }
}

// ============================================================
// AI ANALYSIS
// ============================================================
function buildContext() {
  const c = getConfig();

  const portfolioData = portfolio.map(a => {
    const price = prices[a.symbol];
    const rawPrice = price ? price.c : null;
    const current = rawPrice ? getPriceInCHF(a.symbol, rawPrice).toFixed(4) + ' CHF' : 'prix non disponible';
    const currentNum = rawPrice ? getPriceInCHF(a.symbol, rawPrice) : null;
    const pnlPct = currentNum ? (((currentNum - a.buyPrice) / a.buyPrice) * 100).toFixed(2) + '%' : 'N/A';
    return `- ${a.symbol} (${a.name}, ${a.type}): ${a.qty} unit√©s, achat moy. ${a.buyPrice} CHF, prix actuel ${current}, P&L: ${pnlPct}`;
  }).join('\n') || 'Portefeuille vide';

  const watchData = watchlist.map(a => {
    const price = prices[a.symbol];
    const rawPrice = price ? price.c : null;
    const current = rawPrice ? getPriceInCHF(a.symbol, rawPrice).toFixed(4) + ' CHF' : 'prix non disponible';
    return `- ${a.symbol} (${a.name}, ${a.type}): prix actuel ${current}, raison: ${a.reason || 'non pr√©cis√©e'}`;
  }).join('\n') || 'Aucun actif sous surveillance';

  return `Tu es un conseiller financier personnel expert, parlant fran√ßais. Voici le contexte complet de l'investisseur:

TAUX DE CHANGE ACTUELS:
- 1 USD = ${fxRates.USDCHF.toFixed(4)} CHF
- 1 EUR = ${fxRates.EURCHF.toFixed(4)} CHF

PROFIL INVESTISSEUR:
- Devise: ${c.currency}
- Profil de risque: ${c.riskProfile}
- Budget mensuel √† investir: ${c.monthlyBudget} ${c.currency}
- Horizon d'investissement: ${c.horizon}
- Objectif: ${c.objective}
- Courtier: ${c.broker}
- Frais fixes par transaction: ${c.fixedFees} ${c.currency}
- Frais variables: ${c.varFees}%
- Frais de change: ${c.fxFees}%
- Secteurs favoris: ${c.favSectors || 'non pr√©cis√©'}
- Secteurs √† √©viter: ${c.avoidSectors || 'aucun'}
- Seuil d'alerte perte: ${c.stopLoss}%
- Date du jour: ${new Date().toLocaleDateString('fr-CH')}

PORTEFEUILLE ACTUEL:
${portfolioData}

ACTIFS SOUS SURVEILLANCE:
${watchData}

R√àGLES IMPORTANTES:
- Tiens toujours compte des frais de transaction dans tes recommandations
- Ne sugg√®re jamais d'investir plus que le budget mensuel en une seule fois
- Signale toute position qui d√©passe le seuil de perte d√©fini
- Adapte tes conseils au profil de risque et √† l'horizon d'investissement
- R√©ponds toujours en fran√ßais`;
}

async function runAnalysis() {
  const { anthropicKey } = getConfig();
  if (!anthropicKey) {
    alert('Cl√© API Anthropic manquante. Va dans Param√®tres.');
    showPage('settings');
    return;
  }

  const btn = document.getElementById('analyzeBtn');
  const result = document.getElementById('aiResult');

  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div><span>Analyse en cours‚Ä¶</span>';
  result.classList.remove('placeholder');
  result.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> Claude analyse ton portefeuille‚Ä¶';

  const context = buildContext();
  const prompt = `${context}

T√ÇCHE: Fais une analyse compl√®te et structur√©e:

1. **R√âSUM√â DU PORTEFEUILLE** - √âtat g√©n√©ral, performance globale, commentaire.

2. **ANALYSE PAR POSITION** - Pour chaque actif du portefeuille, donne une recommandation claire: CONSERVER / ACHETER PLUS / VENDRE PARTIELLEMENT / VENDRE TOUT, avec une explication courte et le raisonnement tenant compte des frais.

3. **ACTIFS SOUS SURVEILLANCE** - Pour chaque actif surveill√©, dis si c'est le bon moment d'entrer en position ou d'attendre, et pourquoi.

4. **ALERTES** - Signale tout ce qui n√©cessite une attention imm√©diate (perte excessive, concentration trop forte, etc.)

5. **üíé P√âPITES DU MOMENT** - Sugg√®re 1 √† 2 actifs que je ne suis pas encore mais qui m√©ritent attention selon le contexte de march√© actuel et mon profil. Format JSON √† la fin: [{"symbol":"XXX","name":"Nom complet","reason":"Raison courte"}]

Sois concis, direct et pratique.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': anthropicKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 2000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);

    const text = data.content[0].text;

    // Extract gems JSON
    const gemsMatch = text.match(/\[(\s*\{[\s\S]*?\}\s*,?\s*)*\]/);
    let displayText = text;
    if (gemsMatch) {
      displayText = text.replace(gemsMatch[0], '').trim();
      try {
        const gems = JSON.parse(gemsMatch[0]);
        renderGems(gems);
      } catch(e) {}
    }

    result.textContent = displayText;

  } catch(e) {
    result.textContent = '‚ö†Ô∏è Erreur: ' + e.message + '\n\nV√©rifie ta cl√© API Anthropic dans les param√®tres.';
  }

  btn.disabled = false;
  btn.innerHTML = '<span>Relancer l\'analyse</span>';
}

function renderGems(gems) {
  if (!gems || gems.length === 0) return;
  const grid = document.getElementById('gemsGrid');
  const section = document.getElementById('gemsSection');
  section.style.display = 'block';
  grid.innerHTML = gems.map(g => `
    <div class="gem-card">
      <div class="gem-symbol">${g.symbol}</div>
      <div class="gem-name">${g.name || ''}</div>
      <div class="gem-reason">${g.reason}</div>
      <button class="btn btn-outline btn-sm" style="margin-top:12px" onclick="quickAddWatch('${g.symbol}','${g.name || g.symbol}')">+ Ajouter √† la surveillance</button>
    </div>
  `).join('');
}

function quickAddWatch(symbol, name) {
  if (watchlist.find(a => a.symbol === symbol)) {
    alert('D√©j√† dans ta liste de surveillance.');
    return;
  }
  watchlist.push({ symbol, type: 'action', name, reason: 'Sugg√©r√© par IA', date: new Date().toLocaleDateString('fr-CH'), id: Date.now() });
  saveWatchlist();
  renderWatchlist();
  fetchPricesFor([symbol]);
  alert(`${symbol} ajout√© √† la surveillance !`);
}

// ============================================================
// ASK QUESTION
// ============================================================
async function askQuestion() {
  const { anthropicKey } = getConfig();
  if (!anthropicKey) { alert('Cl√© API Anthropic manquante.'); return; }

  const input = document.getElementById('aiQuestion');
  const question = input.value.trim();
  if (!question) return;

  const result = document.getElementById('aiResult');
  result.classList.remove('placeholder');
  result.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> Claude r√©fl√©chit‚Ä¶';
  input.value = '';

  const context = buildContext();
  const prompt = `${context}\n\nQUESTION DE L'INVESTISSEUR: ${question}\n\nR√©ponds de fa√ßon concise et pratique en tenant compte de tout le contexte ci-dessus.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': anthropicKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    const answer = data.content[0].text;
    result.textContent = answer;

    // Save to history
    history.unshift({ date: new Date().toLocaleString('fr-CH'), question, answer });
    if (history.length > 10) history.pop();
    saveData('aiHistory', history);
    renderHistory();

  } catch(e) {
    result.textContent = '‚ö†Ô∏è Erreur: ' + e.message;
  }
}

function renderHistory() {
  const list = document.getElementById('historyList');
  const section = document.getElementById('historySection');
  if (history.length === 0) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div class="h-date">${h.date}</div>
      <div class="h-q">‚ùì ${h.question}</div>
      <div class="h-a">${h.answer}</div>
    </div>
  `).join('');
}

function clearHistory() {
  history = [];
  saveData('aiHistory', history);
  renderHistory();
}

// ============================================================
// INIT
// ============================================================
async function init() {
  // Affiche un indicateur de chargement
  document.getElementById('lastUpdate').textContent = 'Chargement de tes donn√©es‚Ä¶';

  // Charge toutes les donn√©es depuis le stockage persistant
  await loadAllData();

  // Met √† jour l'interface
  checkSettingsBanner();
  loadSettingsForm();
  renderPortfolio();
  renderWatchlist();
  renderHistory();

  // R√©cup√®re les taux de change et les prix
  await fetchFxRates();
  await refreshPrices();
}

init();
</script>
</body>
</html>
