<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F0; --surface: #FFFFFF; --surface2: #F0EDE6; --border: #E2DDD4;
    --text: #1A1714; --text-secondary: #6B6560;
    --accent: #C4A35A; --accent-dark: #9E7E3A;
    --green: #2D7D4F; --green-bg: #EBF5F0;
    --red: #C0392B; --red-bg: #FDECEA;
    --orange: #C05621; --orange-bg: #FFF3E0;
    --shadow: 0 2px 16px rgba(26,23,20,0.07);
    --shadow-lg: 0 8px 40px rgba(26,23,20,0.12);
    --radius: 14px; --radius-sm: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 15px; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 64px; position: sticky; top: 0; z-index: 100; }
  .logo { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
  .logo span { color: var(--accent); }
  .nav-tabs { display: flex; gap: 4px; }
  .nav-tab { padding: 7px 18px; border-radius: 20px; border: none; background: transparent; color: var(--text-secondary); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .nav-tab:hover { background: var(--surface2); color: var(--text); }
  .nav-tab.active { background: var(--text); color: white; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .last-update { font-size: 12px; color: var(--text-secondary); font-family: 'DM Mono', monospace; }

  main { max-width: 1280px; margin: 0 auto; padding: 28px 24px; }
  .page { display: none; }
  .page.active { display: block; }

  .settings-banner { background: linear-gradient(135deg, #1A1714, #2D2520); color: white; border-radius: var(--radius); padding: 18px 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; }
  .settings-banner.hidden { display: none; }
  .settings-banner p { font-size: 13px; opacity: 0.8; margin-top: 3px; }
  .settings-banner h3 { font-family: 'Playfair Display', serif; font-size: 17px; }

  .btn { padding: 9px 20px; border-radius: 20px; border: none; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--text); color: white; }
  .btn-primary:hover { background: #333; }
  .btn-accent { background: var(--accent); color: white; }
  .btn-accent:hover { background: var(--accent-dark); }
  .btn-outline { background: transparent; color: var(--text); border: 1.5px solid var(--border); }
  .btn-outline:hover { border-color: var(--text); }
  .btn-ghost { background: transparent; color: var(--text-secondary); padding: 6px 10px; }
  .btn-ghost:hover { color: var(--red); background: var(--red-bg); }
  .btn-sm { padding: 6px 14px; font-size: 12px; }
  .btn-configure { background: var(--accent); color: white; border: none; padding: 10px 22px; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; }
  .btn-configure:hover { background: var(--accent-dark); }

  /* DASHBOARD */
  .summary-strip { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .summary-card { background: var(--surface); border-radius: var(--radius); padding: 16px 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
  .summary-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-secondary); margin-bottom: 6px; }
  .summary-card .value { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; }
  .summary-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 3px; }
  .summary-card .sub.green { color: var(--green); font-weight: 600; }
  .summary-card .sub.red { color: var(--red); font-weight: 600; }

  .dashboard-grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; align-items: start; }
  .dashboard-main { display: flex; flex-direction: column; gap: 20px; }
  .dashboard-side { display: flex; flex-direction: column; gap: 20px; }

  .section { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
  .section-header { padding: 16px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .section-title { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

  /* MARKET */
  .market-header { background: linear-gradient(135deg, #1A1714, #2D2520); color: white; padding: 18px 22px; display: flex; align-items: center; justify-content: space-between; }
  .market-title { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; }
  .market-subtitle { font-size: 12px; opacity: 0.65; margin-top: 3px; }
  .market-body { padding: 18px 22px; }
  .market-content { font-size: 14px; line-height: 1.8; white-space: pre-wrap; }
  .market-content.placeholder { color: var(--text-secondary); font-style: italic; }
  .btn-market { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.25); padding: 7px 16px; border-radius: 16px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
  .btn-market:hover { background: rgba(255,255,255,0.25); }
  .btn-market:disabled { opacity: 0.5; cursor: not-allowed; }

  /* PORTFOLIO CARDS */
  .asset-card { padding: 16px 22px; border-bottom: 1px solid var(--border); }
  .asset-card:last-child { border-bottom: none; }
  .asset-card-top { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
  .asset-card-info { flex: 1; }
  .asset-card-name { font-weight: 700; font-size: 15px; }
  .asset-card-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
  .asset-card-right { text-align: right; }
  .asset-card-current { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 600; }
  .asset-card-change { font-size: 12px; margin-top: 3px; }
  .asset-metrics { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 10px; }
  .metric { background: var(--surface2); border-radius: var(--radius-sm); padding: 8px 10px; }
  .metric-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 3px; }
  .metric-value { font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 600; }
  .metric-value.positive { color: var(--green); }
  .metric-value.negative { color: var(--red); }

  .sparkline-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  canvas.spark { height: 36px; flex: 1; display: block; }
  .trend-badge { display: inline-flex; align-items: center; gap: 3px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 10px; white-space: nowrap; }
  .trend-badge.up { background: var(--green-bg); color: var(--green); }
  .trend-badge.down { background: var(--red-bg); color: var(--red); }
  .trend-badge.neutral { background: var(--surface2); color: var(--text-secondary); }

  .ai-comment { background: #FAFAF7; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 13px; line-height: 1.65; color: var(--text); }
  .ai-comment.placeholder-comment { color: var(--text-secondary); font-style: italic; }
  .ai-reco { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 700; padding: 4px 12px; border-radius: 12px; margin-top: 8px; }
  .ai-reco.buy { background: var(--green-bg); color: var(--green); }
  .ai-reco.sell { background: var(--red-bg); color: var(--red); }
  .ai-reco.hold { background: var(--surface2); color: var(--text-secondary); }

  .asset-type { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .type-action { background: #EEF2FF; color: #4338CA; }
  .type-etf { background: #F0FDF4; color: #15803D; }
  .type-crypto { background: #FFF7ED; color: #C2410C; }
  .type-devise { background: #F0F9FF; color: #0369A1; }
  .type-matiere { background: #FDF4FF; color: #7E22CE; }

  .change-badge { display: inline-flex; align-items: center; gap: 3px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; padding: 2px 8px; border-radius: 10px; }
  .change-badge.positive { background: var(--green-bg); color: var(--green); }
  .change-badge.negative { background: var(--red-bg); color: var(--red); }
  .change-badge.neutral { background: var(--surface2); color: var(--text-secondary); }

  /* GEMS SIDE */
  .gem-card { padding: 14px 16px; border-bottom: 1px solid var(--border); }
  .gem-card:last-child { border-bottom: none; }
  .gem-symbol { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: var(--accent); }
  .gem-name { font-size: 12px; color: var(--text-secondary); margin-top: 1px; }
  .gem-reason { font-size: 13px; margin-top: 6px; line-height: 1.5; }

  /* WATCHLIST */
  .watch-card { padding: 16px 22px; border-bottom: 1px solid var(--border); }
  .watch-card:last-child { border-bottom: none; }
  .watch-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .watch-name { font-weight: 700; font-size: 15px; }

  /* OPPORTUNITY */
  .opp-header { background: linear-gradient(135deg, #7C3009, #C05621); color: white; padding: 14px 22px; border-radius: var(--radius) var(--radius) 0 0; display: flex; align-items: center; justify-content: space-between; }
  .opp-title { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; }
  .opp-subtitle { font-size: 12px; opacity: 0.75; margin-top: 2px; }
  .opp-card { padding: 16px 22px; border-bottom: 1px solid var(--border); }
  .opp-card:last-child { border-bottom: none; }

  /* AI CHAT */
  .ai-chat-header { background: linear-gradient(135deg, #1A1714, #2D2520); color: white; padding: 22px 28px; border-radius: var(--radius) var(--radius) 0 0; }
  .ai-chat-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; }
  .ai-chat-subtitle { font-size: 13px; opacity: 0.7; margin-top: 4px; }
  .ai-chat-body { padding: 22px 28px; }
  .ai-result { background: var(--surface2); border-radius: var(--radius-sm); padding: 18px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; min-height: 80px; }
  .ai-result.placeholder { color: var(--text-secondary); font-style: italic; }
  .ai-question-row { display: flex; gap: 12px; margin-top: 20px; }
  .ai-question-input { flex: 1; padding: 12px 18px; border: 1.5px solid var(--border); border-radius: 24px; font-family: 'DM Sans', sans-serif; font-size: 14px; background: var(--surface); color: var(--text); outline: none; transition: border-color 0.2s; }
  .ai-question-input:focus { border-color: var(--accent); }

  .history-item { padding: 14px 22px; border-bottom: 1px solid var(--border); font-size: 13px; }
  .history-item:last-child { border-bottom: none; }
  .history-item .h-date { color: var(--text-secondary); font-size: 11px; font-family: 'DM Mono', monospace; margin-bottom: 4px; }
  .history-item .h-q { font-weight: 600; margin-bottom: 6px; }
  .history-item .h-a { line-height: 1.6; white-space: pre-wrap; }

  /* SETTINGS */
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .settings-section { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 24px; }
  .settings-section h3 { font-family: 'Playfair Display', serif; font-size: 16px; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-secondary); margin-bottom: 6px; }
  .form-input, .form-select { width: 100%; padding: 11px 16px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif; font-size: 14px; background: var(--surface); color: var(--text); outline: none; transition: border-color 0.2s; appearance: none; }
  .form-input:focus, .form-select:focus { border-color: var(--accent); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .api-key-field { position: relative; }
  .toggle-visibility { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 16px; }
  .save-banner { background: var(--green-bg); color: var(--green); padding: 12px 18px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; margin-top: 16px; display: none; align-items: center; gap: 8px; }
  .save-banner.visible { display: flex; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(26,23,20,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(3px); }
  .modal-overlay.active { display: flex; }
  .modal { background: var(--surface); border-radius: var(--radius); padding: 32px; width: 100%; max-width: 500px; box-shadow: var(--shadow-lg); animation: modalIn 0.25s ease; }
  @keyframes modalIn { from { opacity: 0; transform: translateY(16px) scale(0.97); } to { opacity: 1; transform: none; } }
  .modal h2 { font-family: 'Playfair Display', serif; font-size: 22px; margin-bottom: 24px; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  .spinner { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
  .spinner-dark { width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-dots { display: inline-flex; gap: 4px; align-items: center; }
  .loading-dots span { width: 5px; height: 5px; background: var(--accent); border-radius: 50%; animation: dot 1.2s infinite; }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dot { 0%,60%,100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-5px); opacity: 1; } }

  .empty-state { padding: 36px; text-align: center; color: var(--text-secondary); }
  .empty-state .icon { font-size: 32px; margin-bottom: 10px; }
  .empty-state p { font-size: 13px; }

  @media (max-width: 900px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .settings-grid { grid-template-columns: 1fr; }
    .asset-metrics { grid-template-columns: repeat(2,1fr); }
    .nav-tabs { display: none; }
    .summary-strip { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Portfolio<span>.</span></div>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard')">Tableau de bord</button>
    <button class="nav-tab" onclick="showPage('watchlist')">Sous la loupe</button>
    <button class="nav-tab" onclick="showPage('ai')">Discussion IA</button>
    <button class="nav-tab" onclick="showPage('settings')">Param√®tres</button>
  </nav>
  <div class="header-right">
    <span class="last-update" id="lastUpdate">Chargement‚Ä¶</span>
    <button class="btn btn-outline btn-sm" onclick="refreshPrices()">‚Üª Prix</button>
  </div>
</header>

<main>
  <div class="settings-banner hidden" id="settingsBanner">
    <div><h3>‚öôÔ∏è Configuration requise</h3><p>Renseigne tes cl√©s API pour activer toutes les fonctionnalit√©s.</p></div>
    <button class="btn-configure" onclick="showPage('settings')">Configurer ‚Üí</button>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="summary-strip">
      <div class="summary-card">
        <div class="label">Valeur totale</div>
        <div class="value" id="totalValue">‚Äî CHF</div>
        <div class="sub" id="totalPnl">‚Äî</div>
      </div>
      <div class="summary-card">
        <div class="label">Portefeuille</div>
        <div class="value" id="assetCount">0 actifs</div>
        <div class="sub" id="lastAnalysis">Jamais analys√©</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-main">

        <div class="section">
          <div class="market-header">
            <div>
              <div class="market-title">üåç Actualit√© des march√©s</div>
              <div class="market-subtitle">√âconomie ¬∑ G√©opolitique ¬∑ Crypto ¬∑ Ce qui impacte tes investissements</div>
            </div>
            <button class="btn-market" id="marketBtn" onclick="fetchMarketNews()">‚Üª Mettre √† jour</button>
          </div>
          <div class="market-body">
            <div class="market-content placeholder" id="marketContent">Clique sur "Mettre √† jour" pour g√©n√©rer un briefing march√© personnalis√©‚Ä¶</div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <div class="section-title">üíº Mon Portefeuille</div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-accent btn-sm" id="dashAnalyzeBtn" onclick="runDashboardAnalysis()">‚ú¶ Analyser tout</button>
              <button class="btn btn-primary btn-sm" onclick="openModal('portfolio')">+ Ajouter</button>
            </div>
          </div>
          <div id="portfolioCards">
            <div class="empty-state"><div class="icon">üì≠</div><p>Aucun actif. Clique sur "+ Ajouter" pour commencer.</p></div>
          </div>
        </div>

      </div>
      <div class="dashboard-side">
        <div class="section">
          <div class="section-header">
            <div class="section-title">üíé P√©pites du moment</div>
          </div>
          <div id="gemsList">
            <div class="empty-state"><div class="icon">‚ú®</div><p>Lance une analyse pour d√©couvrir des p√©pites.</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SOUS LA LOUPE -->
  <div class="page" id="page-watchlist">
    <div class="section" style="margin-bottom:20px;">
      <div class="section-header">
        <div class="section-title">üîç Sous la Loupe</div>
        <button class="btn btn-primary btn-sm" onclick="openModal('watchlist')">+ Ajouter</button>
      </div>
      <div id="watchlistCards">
        <div class="empty-state"><div class="icon">üî≠</div><p>Aucun actif sous surveillance.</p></div>
      </div>
    </div>

    <div class="section">
      <div class="opp-header">
        <div>
          <div class="opp-title">‚ö° Opportunit√©s √† saisir</div>
          <div class="opp-subtitle">Actifs solides √† prix attractif ‚Äî le moment d'agir est maintenant</div>
        </div>
        <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="openModal('opportunity')">+ Ajouter</button>
      </div>
      <div id="opportunityCards">
        <div class="empty-state"><div class="icon">‚ö°</div><p>Aucune opportunit√© identifi√©e.</p></div>
      </div>
    </div>
  </div>

  <!-- DISCUSSION IA -->
  <div class="page" id="page-ai">
    <div class="section">
      <div class="ai-chat-header">
        <div class="ai-chat-title">‚ú¶ Discussion avec Claude</div>
        <div class="ai-chat-subtitle">Pose des questions pr√©cises ‚Äî Claude conna√Æt ton portefeuille et ton profil</div>
      </div>
      <div class="ai-chat-body">
        <div class="ai-result placeholder" id="aiResult">Pose une question pour commencer‚Ä¶</div>
        <div class="ai-question-row">
          <input type="text" class="ai-question-input" id="aiQuestion" placeholder="Ex: J'ai 300 CHF √† investir ce mois-ci, que me conseilles-tu ?" onkeydown="if(event.key==='Enter') askQuestion()">
          <button class="btn btn-accent" onclick="askQuestion()">Envoyer</button>
        </div>
      </div>
    </div>
    <div class="section" id="historySection" style="display:none;margin-top:20px;">
      <div class="section-header">
        <div class="section-title">üïí Historique</div>
        <button class="btn btn-ghost btn-sm" onclick="clearHistory()">Effacer</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- PARAM√àTRES -->
  <div class="page" id="page-settings">
    <div class="settings-grid">
      <div class="settings-section">
        <h3>üîë Cl√©s API</h3>
        <div class="form-group">
          <label class="form-label">Cl√© API Finnhub</label>
          <div class="api-key-field">
            <input type="password" class="form-input" id="finnhubKey" placeholder="cq1abc123...">
            <button class="toggle-visibility" onclick="toggleVis('finnhubKey')">üëÅ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Cl√© API Anthropic (Claude)</label>
          <div class="api-key-field">
            <input type="password" class="form-input" id="anthropicKey" placeholder="sk-ant-...">
            <button class="toggle-visibility" onclick="toggleVis('anthropicKey')">üëÅ</button>
          </div>
        </div>
        <div class="form-group" style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
          <label class="form-label">üîÑ Synchronisation multi-appareils</label>
          <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">JSONBin ‚Äî saisir une fois par appareil</p>
        </div>
        <div class="form-group">
          <label class="form-label">JSONBin ‚Äî BIN ID</label>
          <input type="text" class="form-input" id="jsonBinId" placeholder="65abc123...">
        </div>
        <div class="form-group">
          <label class="form-label">JSONBin ‚Äî Access Key</label>
          <div class="api-key-field">
            <input type="password" class="form-input" id="jsonBinKey" placeholder="$2a$10$...">
            <button class="toggle-visibility" onclick="toggleVis('jsonBinKey')">üëÅ</button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveKeys()">Sauvegarder les cl√©s</button>
        <div class="save-banner" id="keysBanner">‚úì Cl√©s sauvegard√©es</div>
      </div>

      <div class="settings-section">
        <h3>üë§ Profil Investisseur</h3>
        <div class="form-group">
          <label class="form-label">Devise principale</label>
          <select class="form-select" id="currency">
            <option value="CHF">CHF ‚Äì Franc suisse</option>
            <option value="EUR">EUR ‚Äì Euro</option>
            <option value="USD">USD ‚Äì Dollar</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Profil de risque</label>
          <select class="form-select" id="riskProfile">
            <option value="prudent">Prudent</option>
            <option value="equilibre">√âquilibr√©</option>
            <option value="dynamique">Dynamique</option>
            <option value="agressif">Tr√®s agressif</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Budget mensuel (CHF)</label>
          <input type="number" class="form-input" id="monthlyBudget" placeholder="300">
        </div>
        <div class="form-group">
          <label class="form-label">Horizon d'investissement</label>
          <select class="form-select" id="horizon">
            <option value="court">Court terme</option>
            <option value="moyen">Moyen terme</option>
            <option value="long">Long terme</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">Sauvegarder</button>
        <div class="save-banner" id="profileBanner">‚úì Profil sauvegard√©</div>
      </div>

      <div class="settings-section">
        <h3>üè¶ Courtier & Frais</h3>
        <div class="form-group">
          <label class="form-label">Courtier</label>
          <input type="text" class="form-input" id="broker" placeholder="UBS">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Frais fixes (CHF)</label>
            <input type="number" class="form-input" id="fixedFees" placeholder="9">
          </div>
          <div class="form-group">
            <label class="form-label">Frais variables (%)</label>
            <input type="number" class="form-input" id="varFees" placeholder="0.5" step="0.1">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Frais de change (%)</label>
          <input type="number" class="form-input" id="fxFees" placeholder="1.5" step="0.1">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">Sauvegarder</button>
        <div class="save-banner" id="profileBanner2">‚úì Sauvegard√©</div>
      </div>

      <div class="settings-section">
        <h3>üéØ Strat√©gie</h3>
        <div class="form-group">
          <label class="form-label">Objectif</label>
          <select class="form-select" id="objective">
            <option value="croissance">Croissance du capital</option>
            <option value="revenus">Revenus / dividendes</option>
            <option value="retraite">Retraite</option>
            <option value="mixte">Mixte</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Secteurs √† favoriser</label>
          <input type="text" class="form-input" id="favSectors" placeholder="tech, sant√©‚Ä¶">
        </div>
        <div class="form-group">
          <label class="form-label">Secteurs √† √©viter</label>
          <input type="text" class="form-input" id="avoidSectors" placeholder="armement, tabac‚Ä¶">
        </div>
        <div class="form-group">
          <label class="form-label">Alerte perte max (%)</label>
          <input type="number" class="form-input" id="stopLoss" placeholder="15">
        </div>
        <button class="btn btn-primary" onclick="saveStrategy()">Sauvegarder</button>
        <div class="save-banner" id="strategyBanner">‚úì Strat√©gie sauvegard√©e</div>
      </div>
    </div>
  </div>
</main>

<!-- MODALS -->
<div class="modal-overlay" id="modal-portfolio">
  <div class="modal">
    <h2>‚ûï Ajouter au portefeuille</h2>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Symbole</label><input type="text" class="form-input" id="p-symbol" placeholder="ex: BINANCE:BTCUSDT" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="p-type"><option value="action">Action</option><option value="etf">ETF</option><option value="crypto">Crypto</option><option value="devise">Devise</option><option value="matiere">Mati√®re premi√®re</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Nom complet</label><input type="text" class="form-input" id="p-name" placeholder="ex: Bitcoin"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Quantit√©</label><input type="number" class="form-input" id="p-qty" step="any"></div>
      <div class="form-group"><label class="form-label">Prix d'achat moyen (CHF)</label><input type="number" class="form-input" id="p-buyPrice" step="any"></div>
    </div>
    <div class="form-group"><label class="form-label">Date d'achat</label><input type="date" class="form-input" id="p-date"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('portfolio')">Annuler</button>
      <button class="btn btn-primary" onclick="addToPortfolio()">Ajouter</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-watchlist">
  <div class="modal">
    <h2>üîç Ajouter √† la surveillance</h2>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Symbole</label><input type="text" class="form-input" id="w-symbol" placeholder="ex: MSFT" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="w-type"><option value="action">Action</option><option value="etf">ETF</option><option value="crypto">Crypto</option><option value="devise">Devise</option><option value="matiere">Mati√®re premi√®re</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Nom complet</label><input type="text" class="form-input" id="w-name" placeholder="ex: Microsoft Corp."></div>
    <div class="form-group"><label class="form-label">Raison de suivi</label><input type="text" class="form-input" id="w-reason" placeholder="ex: IA, cloud, forte croissance‚Ä¶"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('watchlist')">Annuler</button>
      <button class="btn btn-primary" onclick="addToWatchlist()">Ajouter</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-opportunity">
  <div class="modal">
    <h2>‚ö° Ajouter une opportunit√©</h2>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Symbole</label><input type="text" class="form-input" id="o-symbol" placeholder="ex: BINANCE:SOLUSDT" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="o-type"><option value="action">Action</option><option value="etf">ETF</option><option value="crypto">Crypto</option><option value="devise">Devise</option><option value="matiere">Mati√®re premi√®re</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Nom complet</label><input type="text" class="form-input" id="o-name" placeholder="ex: Solana"></div>
    <div class="form-group"><label class="form-label">Pourquoi c'est une opportunit√© ?</label><input type="text" class="form-input" id="o-reason" placeholder="ex: Correction -40%, fondamentaux solides‚Ä¶"></div>
    <div class="form-group"><label class="form-label">Prix cible d'entr√©e (CHF, optionnel)</label><input type="number" class="form-input" id="o-target" step="any" placeholder="ex: 120"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('opportunity')">Annuler</button>
      <button class="btn btn-primary" onclick="addOpportunity()">Ajouter</button>
    </div>
  </div>
</div>

<script>
// STATE
let portfolio = [], watchlist = [], opportunities = [], history = [];
let prices = {}, fxRates = { USDCHF: 1, EURCHF: 1 }, _config = {};
let aiComments = {};

// STORAGE
function getJsonBinConfig() {
  return { binId: localStorage.getItem('jsonBinId') || '', apiKey: localStorage.getItem('jsonBinKey') || '' };
}

async function saveAllData() {
  const { binId, apiKey } = getJsonBinConfig();
  if (!binId || !apiKey) {
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    localStorage.setItem('watchlist', JSON.stringify(watchlist));
    localStorage.setItem('opportunities', JSON.stringify(opportunities));
    localStorage.setItem('aiHistory', JSON.stringify(history));
    localStorage.setItem('config', JSON.stringify(_config));
    return;
  }
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Access-Key': apiKey },
      body: JSON.stringify({ portfolio, watchlist, opportunities, history, config: _config })
    });
  } catch(e) { console.warn('Erreur save:', e); }
}

async function loadAllData() {
  const { binId, apiKey } = getJsonBinConfig();
  if (!binId || !apiKey) {
    const p = localStorage.getItem('portfolio'), w = localStorage.getItem('watchlist');
    const o = localStorage.getItem('opportunities'), h = localStorage.getItem('aiHistory');
    const c = localStorage.getItem('config');
    if (p) portfolio = JSON.parse(p);
    if (w) watchlist = JSON.parse(w);
    if (o) opportunities = JSON.parse(o);
    if (h) history = JSON.parse(h);
    if (c) _config = JSON.parse(c);
    return;
  }
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
      headers: { 'X-Access-Key': apiKey }
    });
    const data = await res.json();
    if (data.record) {
      if (data.record.portfolio) portfolio = data.record.portfolio;
      if (data.record.watchlist) watchlist = data.record.watchlist;
      if (data.record.opportunities) opportunities = data.record.opportunities;
      if (data.record.history) history = data.record.history;
      if (data.record.config) _config = data.record.config;
    }
  } catch(e) { console.warn('Erreur load:', e); }
}

// CONFIG
function getConfig() {
  return {
    finnhubKey: _config.finnhubKey || '', anthropicKey: _config.anthropicKey || '',
    currency: _config.currency || 'CHF', riskProfile: _config.riskProfile || 'equilibre',
    monthlyBudget: _config.monthlyBudget || '300', horizon: _config.horizon || 'long',
    broker: _config.broker || 'UBS', fixedFees: _config.fixedFees || '9',
    varFees: _config.varFees || '0.5', fxFees: _config.fxFees || '1.5',
    objective: _config.objective || 'mixte', favSectors: _config.favSectors || '',
    avoidSectors: _config.avoidSectors || '', stopLoss: _config.stopLoss || '15',
  };
}

// NAV
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const idx = ['dashboard','watchlist','ai','settings'].indexOf(name);
  document.querySelectorAll('.nav-tab')[idx]?.classList.add('active');
}

// SETTINGS
function loadSettingsForm() {
  const c = getConfig();
  ['finnhubKey','anthropicKey','currency','riskProfile','monthlyBudget','horizon','broker','fixedFees','varFees','fxFees','objective','favSectors','avoidSectors','stopLoss'].forEach(k => {
    const el = document.getElementById(k); if (el) el.value = c[k];
  });
  document.getElementById('jsonBinId').value = localStorage.getItem('jsonBinId') || '';
  document.getElementById('jsonBinKey').value = localStorage.getItem('jsonBinKey') || '';
}

function saveKeys() {
  _config.finnhubKey = document.getElementById('finnhubKey').value.trim();
  _config.anthropicKey = document.getElementById('anthropicKey').value.trim();
  localStorage.setItem('jsonBinId', document.getElementById('jsonBinId').value.trim());
  localStorage.setItem('jsonBinKey', document.getElementById('jsonBinKey').value.trim());
  saveAllData(); showBanner('keysBanner'); checkSettingsBanner();
}

function saveProfile() {
  ['currency','riskProfile','monthlyBudget','horizon','broker','fixedFees','varFees','fxFees'].forEach(k => { _config[k] = document.getElementById(k).value; });
  saveAllData(); showBanner('profileBanner'); showBanner('profileBanner2');
}

function saveStrategy() {
  ['objective','favSectors','avoidSectors','stopLoss'].forEach(k => { _config[k] = document.getElementById(k).value; });
  saveAllData(); showBanner('strategyBanner');
}

function showBanner(id) {
  const b = document.getElementById(id); if (!b) return;
  b.classList.add('visible'); setTimeout(() => b.classList.remove('visible'), 2500);
}

function toggleVis(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }

function checkSettingsBanner() {
  const c = getConfig();
  document.getElementById('settingsBanner').classList.toggle('hidden', !!(c.finnhubKey && c.anthropicKey));
}

// MODALS
function openModal(type) {
  document.getElementById('modal-' + type).classList.add('active');
  if (type === 'portfolio') document.getElementById('p-date').value = new Date().toISOString().split('T')[0];
}
function closeModal(type) { document.getElementById('modal-' + type).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }); });

// PORTFOLIO
function addToPortfolio() {
  const symbol = document.getElementById('p-symbol').value.trim();
  const type = document.getElementById('p-type').value;
  const name = document.getElementById('p-name').value.trim() || symbol;
  const qty = parseFloat(document.getElementById('p-qty').value);
  const buyPrice = parseFloat(document.getElementById('p-buyPrice').value);
  const date = document.getElementById('p-date').value;
  if (!symbol || isNaN(qty) || isNaN(buyPrice)) { alert('Remplis tous les champs obligatoires.'); return; }
  const existing = portfolio.find(a => a.symbol === symbol);
  if (existing) {
    const total = existing.qty + qty;
    existing.buyPrice = ((existing.buyPrice * existing.qty) + (buyPrice * qty)) / total;
    existing.qty = total;
  } else {
    portfolio.push({ symbol, type, name, qty, buyPrice, date, id: Date.now() });
  }
  saveAllData(); closeModal('portfolio'); renderPortfolio(); fetchPricesFor([symbol]);
  ['p-symbol','p-name','p-qty','p-buyPrice'].forEach(id => document.getElementById(id).value = '');
}

function removeFromPortfolio(id) {
  if (!confirm('Supprimer cet actif ?')) return;
  portfolio = portfolio.filter(a => a.id !== id);
  saveAllData(); renderPortfolio(); updateSummary();
}

// WATCHLIST
function addToWatchlist() {
  const symbol = document.getElementById('w-symbol').value.trim();
  if (!symbol) { alert('Symbole requis.'); return; }
  if (watchlist.find(a => a.symbol === symbol)) { alert('D√©j√† dans la surveillance.'); return; }
  watchlist.push({ symbol, type: document.getElementById('w-type').value, name: document.getElementById('w-name').value.trim() || symbol, reason: document.getElementById('w-reason').value.trim(), date: new Date().toLocaleDateString('fr-CH'), id: Date.now() });
  saveAllData(); closeModal('watchlist'); renderWatchlist(); fetchPricesFor([symbol]);
  ['w-symbol','w-name','w-reason'].forEach(id => document.getElementById(id).value = '');
}

function removeFromWatchlist(id) { watchlist = watchlist.filter(a => a.id !== id); saveAllData(); renderWatchlist(); }

// OPPORTUNITIES
function addOpportunity() {
  const symbol = document.getElementById('o-symbol').value.trim();
  if (!symbol) { alert('Symbole requis.'); return; }
  opportunities.push({ symbol, type: document.getElementById('o-type').value, name: document.getElementById('o-name').value.trim() || symbol, reason: document.getElementById('o-reason').value.trim(), target: parseFloat(document.getElementById('o-target').value) || null, date: new Date().toLocaleDateString('fr-CH'), id: Date.now() });
  saveAllData(); closeModal('opportunity'); renderOpportunities(); fetchPricesFor([symbol]);
  ['o-symbol','o-name','o-reason','o-target'].forEach(id => document.getElementById(id).value = '');
}

function removeOpportunity(id) { opportunities = opportunities.filter(a => a.id !== id); saveAllData(); renderOpportunities(); }

// PRICES
function getPriceInCHF(symbol, priceUSD) {
  const asset = [...portfolio, ...watchlist, ...opportunities].find(a => a.symbol === symbol);
  if (!asset) return priceUSD;
  if (asset.type === 'crypto' || (asset.type === 'action' && !symbol.includes('.'))) return priceUSD * fxRates.USDCHF;
  return priceUSD;
}

async function fetchPricesFor(symbols) {
  const { finnhubKey } = getConfig();
  if (!finnhubKey) return;
  for (const s of symbols) {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${finnhubKey}`);
      const data = await res.json();
      if (data.c && data.c > 0) prices[s] = data;
    } catch(e) {}
  }
  renderPortfolio(); renderWatchlist(); renderOpportunities(); updateSummary();
}

async function fetchFxRates() {
  try {
    const res = await fetch('https://open.er-api.com/v6/latest/USD');
    const data = await res.json();
    if (data.rates?.CHF) fxRates.USDCHF = data.rates.CHF;
    if (data.rates?.EUR && data.rates?.CHF) fxRates.EURCHF = data.rates.CHF / data.rates.EUR;
    document.getElementById('lastUpdate').textContent = `1 USD = ${fxRates.USDCHF.toFixed(4)} CHF ¬∑ ${new Date().toLocaleTimeString('fr-CH',{hour:'2-digit',minute:'2-digit'})}`;
  } catch(e) {}
}

async function refreshPrices() {
  await fetchFxRates();
  const all = [...new Set([...portfolio,...watchlist,...opportunities].map(a=>a.symbol))];
  if (all.length) await fetchPricesFor(all);
}

// SPARKLINE
async function fetchSparklineAndTrend(symbol) {
  const { finnhubKey } = getConfig();
  if (!finnhubKey) return;
  const to = Math.floor(Date.now()/1000), from = to - 30*24*3600;
  const safeId = symbol.replace(/[^a-zA-Z0-9]/g,'');
  try {
    const res = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${finnhubKey}`);
    const data = await res.json();
    if (data.c && data.c.length > 1) {
      const canvas = document.getElementById('spark-' + safeId);
      if (canvas) {
        const ctx = canvas.getContext('2d');
        const w = canvas.offsetWidth || 180, h = 36;
        canvas.width = w; canvas.height = h;
        const vals = data.c, min = Math.min(...vals), max = Math.max(...vals), range = max - min || 1;
        const isUp = vals[vals.length-1] >= vals[0];
        ctx.beginPath();
        vals.forEach((v,i) => {
          const x = (i/(vals.length-1))*w, y = h - ((v-min)/range)*(h-4) - 2;
          i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        });
        ctx.strokeStyle = isUp ? '#2D7D4F' : '#C0392B';
        ctx.lineWidth = 2; ctx.stroke();
      }
      const trendPct = ((data.c[data.c.length-1]-data.c[0])/data.c[0])*100;
      const trendEl = document.getElementById('trend-' + safeId);
      if (trendEl) {
        trendEl.className = 'trend-badge ' + (trendPct >= 0 ? 'up' : 'down');
        trendEl.textContent = `1M ${trendPct >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(trendPct).toFixed(1)}%`;
      }
    }
  } catch(e) {}
}

// RENDER PORTFOLIO
function renderPortfolio() {
  const container = document.getElementById('portfolioCards');
  if (portfolio.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>Aucun actif. Clique sur "+ Ajouter".</p></div>';
    return;
  }
  container.innerHTML = portfolio.map(asset => {
    const price = prices[asset.symbol];
    const rawPrice = price?.c;
    const currentPrice = rawPrice ? getPriceInCHF(asset.symbol, rawPrice) : null;
    const change24h = price?.dp ?? null;
    const value = currentPrice ? currentPrice * asset.qty : null;
    const pnl = currentPrice ? (currentPrice - asset.buyPrice) * asset.qty : null;
    const pnlPct = currentPrice ? ((currentPrice - asset.buyPrice) / asset.buyPrice) * 100 : null;
    const cc = change24h === null ? 'neutral' : change24h >= 0 ? 'positive' : 'negative';
    const pc = pnl === null ? '' : pnl >= 0 ? 'positive' : 'negative';
    const comment = aiComments[asset.symbol];
    const safeId = asset.symbol.replace(/[^a-zA-Z0-9]/g,'');
    return `
      <div class="asset-card">
        <div class="asset-card-top">
          <div class="asset-card-info">
            <div class="asset-card-name">${asset.symbol} <span class="asset-type type-${asset.type}">${asset.type}</span></div>
            <div class="asset-card-sub">${asset.name}</div>
          </div>
          <div class="asset-card-right">
            <div class="asset-card-current">${currentPrice ? currentPrice.toFixed(4)+' CHF' : '‚Äî'}</div>
            <div class="asset-card-change"><span class="change-badge ${cc}">${change24h !== null ? (change24h>=0?'‚ñ≤':'‚ñº')+' '+Math.abs(change24h).toFixed(2)+'%' : '‚Äî'}</span></div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="removeFromPortfolio(${asset.id})">‚úï</button>
        </div>
        <div class="asset-metrics">
          <div class="metric"><div class="metric-label">Quantit√©</div><div class="metric-value">${asset.qty}</div></div>
          <div class="metric"><div class="metric-label">Achat moy.</div><div class="metric-value">${asset.buyPrice.toFixed(2)} CHF</div></div>
          <div class="metric"><div class="metric-label">Valeur</div><div class="metric-value">${value ? value.toFixed(2)+' CHF' : '‚Äî'}</div></div>
          <div class="metric"><div class="metric-label">+/- Latent</div><div class="metric-value ${pc}">${pnl !== null ? (pnl>=0?'+':'')+pnl.toFixed(2)+' CHF' : '‚Äî'}<br><small>${pnlPct !== null ? (pnlPct>=0?'+':'')+pnlPct.toFixed(1)+'%' : ''}</small></div></div>
        </div>
        <div class="sparkline-row">
          <canvas class="spark" id="spark-${safeId}" height="36"></canvas>
          <span class="trend-badge neutral" id="trend-${safeId}">1M ‚Äî</span>
        </div>
        <div class="ai-comment ${comment ? '' : 'placeholder-comment'}" id="comment-${safeId}">
          ${comment ? comment.text + (comment.reco ? `<br><span class="ai-reco ${comment.recoClass}">${comment.reco}</span>` : '') : '‚ú¶ Clique sur "Analyser tout" pour une recommandation‚Ä¶'}
        </div>
      </div>`;
  }).join('');
  portfolio.forEach(a => fetchSparklineAndTrend(a.symbol));
}

// RENDER WATCHLIST
function renderWatchlist() {
  const c = document.getElementById('watchlistCards');
  if (!watchlist.length) { c.innerHTML = '<div class="empty-state"><div class="icon">üî≠</div><p>Aucun actif sous surveillance.</p></div>'; return; }
  c.innerHTML = watchlist.map(a => {
    const price = prices[a.symbol];
    const cp = price ? getPriceInCHF(a.symbol, price.c) : null;
    const ch = price?.dp ?? null;
    const cc = ch === null ? 'neutral' : ch >= 0 ? 'positive' : 'negative';
    return `<div class="watch-card">
      <div class="watch-top">
        <div><span class="watch-name">${a.symbol}</span> <span class="asset-type type-${a.type}" style="margin-left:6px">${a.type}</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600">${cp ? cp.toFixed(4)+' CHF' : '‚Äî'}</span>
          <span class="change-badge ${cc}">${ch !== null ? (ch>=0?'‚ñ≤':'‚ñº')+' '+Math.abs(ch).toFixed(2)+'%' : '‚Äî'}</span>
          <button class="btn btn-ghost btn-sm" onclick="removeFromWatchlist(${a.id})">‚úï</button>
        </div>
      </div>
      <div style="font-size:13px;color:var(--text)">${a.name}${a.reason ? ' ¬∑ '+a.reason : ''}</div>
      <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;font-family:'DM Mono',monospace">Ajout√© le ${a.date}</div>
    </div>`;
  }).join('');
}

// RENDER OPPORTUNITIES
function renderOpportunities() {
  const c = document.getElementById('opportunityCards');
  if (!opportunities.length) { c.innerHTML = '<div class="empty-state"><div class="icon">‚ö°</div><p>Aucune opportunit√© identifi√©e.</p></div>'; return; }
  c.innerHTML = opportunities.map(a => {
    const price = prices[a.symbol];
    const cp = price ? getPriceInCHF(a.symbol, price.c) : null;
    const ch = price?.dp ?? null;
    const cc = ch === null ? 'neutral' : ch >= 0 ? 'positive' : 'negative';
    const targetReached = a.target && cp && cp <= a.target;
    return `<div class="opp-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div>
          <span style="font-weight:700;font-size:15px">${a.symbol}</span>
          <span class="asset-type type-${a.type}" style="margin-left:8px">${a.type}</span>
          ${targetReached ? '<span style="background:var(--green-bg);color:var(--green);font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:8px">üéØ Prix cible atteint !</span>' : ''}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600">${cp ? cp.toFixed(4)+' CHF' : '‚Äî'}</span>
          <span class="change-badge ${cc}">${ch !== null ? (ch>=0?'‚ñ≤':'‚ñº')+' '+Math.abs(ch).toFixed(2)+'%' : '‚Äî'}</span>
          <button class="btn btn-ghost btn-sm" onclick="removeOpportunity(${a.id})">‚úï</button>
        </div>
      </div>
      <div style="font-size:13px;color:var(--text)">${a.name}</div>
      <div style="font-size:13px;color:var(--text-secondary);margin-top:4px">${a.reason}</div>
      ${a.target ? `<div style="font-size:12px;color:var(--orange);margin-top:4px;font-weight:600">Prix cible : ${a.target} CHF</div>` : ''}
      <div style="font-size:11px;color:var(--text-secondary);margin-top:6px;font-family:'DM Mono',monospace">Ajout√© le ${a.date}</div>
    </div>`;
  }).join('');
}

// SUMMARY
function updateSummary() {
  const v = portfolio.filter(a => prices[a.symbol]?.c > 0);
  const tv = v.reduce((s,a) => s + getPriceInCHF(a.symbol, prices[a.symbol].c) * a.qty, 0);
  const tc = v.reduce((s,a) => s + a.buyPrice * a.qty, 0);
  const pnl = tv - tc, pnlPct = tc > 0 ? (pnl/tc)*100 : 0;
  document.getElementById('totalValue').textContent = tv > 0 ? tv.toFixed(2)+' CHF' : '‚Äî CHF';
  document.getElementById('assetCount').textContent = portfolio.length + ' actif' + (portfolio.length > 1 ? 's' : '');
  if (tc > 0) {
    const el = document.getElementById('totalPnl');
    el.textContent = `${pnl>=0?'+':''}${pnl.toFixed(2)} CHF (${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%)`;
    el.className = 'sub ' + (pnl >= 0 ? 'green' : 'red');
  }
}

// MARKET NEWS
// Variable globale pour stocker le contexte march√© utilis√© dans l'analyse
let lastMarketContext = '';

async function fetchMarketNews(silent = false) {
  const { anthropicKey } = getConfig();
  if (!anthropicKey) { if (!silent) { alert('Cl√© API Anthropic manquante.'); showPage('settings'); } return ''; }
  const btn = document.getElementById('marketBtn'), content = document.getElementById('marketContent');
  if (!silent) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> G√©n√©ration‚Ä¶'; }
  content.classList.remove('placeholder');
  content.innerHTML = '<div style="display:flex;gap:8px;align-items:center;color:var(--text-secondary);font-size:13px"><div class="spinner-dark"></div> Analyse des march√©s en cours‚Ä¶</div>';

  const c = getConfig();
  const hasCrypto = portfolio.some(a => a.type === 'crypto') || watchlist.some(a => a.type === 'crypto');
  const cryptoNames = [...portfolio, ...watchlist].filter(a => a.type === 'crypto').map(a => a.name).join(', ') || 'Bitcoin, Ethereum';
  const tradNames = [...portfolio, ...watchlist].filter(a => a.type !== 'crypto').map(a => a.name).join(', ') || 'march√©s actions';

  const prompt = `Tu es un analyste financier senior et sp√©cialiste en cryptomonnaies. Date: ${new Date().toLocaleDateString('fr-CH')}. Profil investisseur: ${c.riskProfile}.

G√©n√®re un briefing march√© structur√© en fran√ßais (450 mots max) en DEUX PARTIES DISTINCTES:

---
üìä MARCH√âS TRADITIONNELS
‚Ä¢ Macro-√©conomie: taux d'int√©r√™t (Fed, BCE), inflation, croissance, emploi ‚Äî 2-3 points cl√©s avec chiffres si possible
‚Ä¢ G√©opolitique: conflits, tensions commerciales, √©lections ‚Äî impacts concrets sur les march√©s
‚Ä¢ Actions & mati√®res premi√®res: tendances sectorielles, or, p√©trole ‚Äî pertinent pour: ${tradNames || 'march√©s g√©n√©raux'}
‚Ä¢ Signal principal: 1 phrase sur le sentiment g√©n√©ral (risk-on / risk-off)

---
‚Çø MARCH√âS CRYPTO
‚Ä¢ Sentiment global: Fear & Greed index estim√©, dominance BTC, flux institutionnels
‚Ä¢ Actualit√© r√©glementaire: nouvelles lois, ETF, exchanges ‚Äî impact concret
‚Ä¢ Mouvements notables: ${cryptoNames} ‚Äî tendances, catalyseurs haussiers/baissiers
‚Ä¢ Niveau technique cl√© si pertinent: support/r√©sistance majeur sur BTC ou ETH
‚Ä¢ Signal principal: 1 phrase sur le momentum crypto actuel

---
‚ö†Ô∏è POINTS DE VIGILANCE CETTE SEMAINE
2-3 risques ou opportunit√©s sp√©cifiques √† surveiller, class√©s par priorit√©

Sois direct, factuel, orient√© action. Utilise des donn√©es r√©centes de ta connaissance.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': anthropicKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({ model: 'claude-sonnet-4-6', max_tokens: 1200, messages: [{ role: 'user', content: prompt }] })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    const marketText = data.content[0].text;
    content.textContent = marketText;
    lastMarketContext = marketText;
    return marketText;
  } catch(e) {
    content.textContent = '‚ö†Ô∏è Erreur: ' + e.message;
    return '';
  } finally {
    if (!silent) { btn.disabled = false; btn.innerHTML = '‚Üª Mettre √† jour'; }
  }
}

// DASHBOARD ANALYSIS ‚Äî 3 √©tapes : contexte march√© ‚Üí analyse positions ‚Üí p√©pites
async function runDashboardAnalysis() {
  const { anthropicKey } = getConfig();
  if (!anthropicKey) { alert('Cl√© API Anthropic manquante.'); showPage('settings'); return; }
  if (!portfolio.length) { alert('Ajoute d\'abord des actifs.'); return; }

  const btn = document.getElementById('dashAnalyzeBtn');
  btn.disabled = true;
  document.getElementById('lastAnalysis').textContent = 'Analyse en cours‚Ä¶';

  const c = getConfig();

  // √âTAPE 1 ‚Äî R√©cup√©rer le contexte march√© (affiche dans le briefing en m√™me temps)
  btn.innerHTML = '<div class="spinner"></div> 1/2 March√©s‚Ä¶';
  const marketContext = await fetchMarketNews(true);
  document.getElementById('marketBtn').disabled = false;
  document.getElementById('marketBtn').innerHTML = '‚Üª Mettre √† jour';

  // √âTAPE 2 ‚Äî Analyser chaque position en tenant compte du contexte march√©
  btn.innerHTML = '<div class="spinner"></div> 2/2 Positions‚Ä¶';

  const portfolioData = portfolio.map(a => {
    const price = prices[a.symbol];
    const cp = price ? getPriceInCHF(a.symbol, price.c) : null;
    const pct = cp ? (((cp - a.buyPrice) / a.buyPrice) * 100).toFixed(2) : 'N/A';
    const change24h = price?.dp !== undefined ? price.dp.toFixed(2) + '%' : 'N/A';
    return `${a.symbol} (${a.name}, ${a.type}): ${a.qty} unit√©s | achat: ${a.buyPrice} CHF | actuel: ${cp ? cp.toFixed(4)+' CHF' : 'N/A'} | P&L: ${pct}% | var 24h: ${change24h}`;
  }).join('\n');

  const analysisPrompt = `Tu es un conseiller financier expert. Tu dois analyser le portefeuille EN TENANT COMPTE du contexte de march√© fourni ci-dessous.

PROFIL INVESTISSEUR:
- Profil risque: ${c.riskProfile}
- Budget mensuel: ${c.monthlyBudget} ${c.currency}
- Courtier: ${c.broker} | Frais fixes: ${c.fixedFees} CHF | Frais variables: ${c.varFees}%
- Horizon: ${c.horizon} | Objectif: ${c.objective}
- Taux: 1 USD = ${fxRates.USDCHF.toFixed(4)} CHF

CONTEXTE DE MARCH√â ACTUEL:
${marketContext || 'Contexte non disponible ‚Äî base-toi sur tes connaissances r√©centes.'}

PORTEFEUILLE:
${portfolioData}

T√ÇCHE: Pour chaque position, analyse l'impact du contexte macro ET crypto sur son √©volution probable, puis donne une recommandation chiffr√©e.

R√©ponds UNIQUEMENT en JSON valide, sans texte avant ou apr√®s:
{
  "positions": [
    {
      "symbol": "SYMBOLE",
      "comment": "2-3 phrases: √©tat de la position + impact sp√©cifique du contexte macro/crypto sur cet actif + perspective d'√©volution",
      "reco": "ACHETER X CHF" ou "VENDRE X CHF" ou "NE RIEN FAIRE",
      "recoType": "buy" ou "sell" ou "hold"
    }
  ],
  "gems": [
    {
      "symbol": "SYMBOLE",
      "name": "Nom complet",
      "reason": "Pourquoi c'est une p√©pite dans le contexte actuel"
    }
  ]
}

R√àGLES:
- Pour chaque crypto: mentionne le support/r√©sistance technique si pertinent
- Tiens TOUJOURS compte des frais de transaction (min ${c.fixedFees} CHF) dans les recommandations d'achat/vente
- Ne recommande jamais d'investir plus que le budget mensuel en une fois
- Si le contexte est d√©favorable pour un actif, dis-le clairement`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': anthropicKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({ model: 'claude-sonnet-4-6', max_tokens: 2500, messages: [{ role: 'user', content: analysisPrompt }] })
    });
    const resp = await res.json();
    if (resp.error) throw new Error(resp.error.message);
    let text = resp.content[0].text.trim().replace(/```json|```/g,'').trim();
    const parsed = JSON.parse(text);
    if (parsed.positions) parsed.positions.forEach(p => { aiComments[p.symbol] = { text: p.comment, reco: p.reco, recoClass: p.recoType }; });
    if (parsed.gems) renderGems(parsed.gems);
    renderPortfolio();
    document.getElementById('lastAnalysis').textContent = 'Analys√© √† ' + new Date().toLocaleTimeString('fr-CH',{hour:'2-digit',minute:'2-digit'});
  } catch(e) {
    alert('Erreur analyse positions: ' + e.message);
    document.getElementById('lastAnalysis').textContent = 'Erreur d\'analyse';
  }

  btn.disabled = false; btn.innerHTML = '‚ú¶ Analyser tout';
}

function renderGems(gems) {
  const c = document.getElementById('gemsList');
  if (!gems?.length) return;
  c.innerHTML = gems.map(g => `<div class="gem-card">
    <div class="gem-symbol">${g.symbol}</div>
    <div class="gem-name">${g.name||''}</div>
    <div class="gem-reason">${g.reason}</div>
    <button class="btn btn-outline btn-sm" style="margin-top:10px" onclick="quickAddWatch('${g.symbol}','${(g.name||g.symbol).replace(/'/g,'')}')">+ Surveiller</button>
  </div>`).join('');
}

function quickAddWatch(symbol, name) {
  if (watchlist.find(a => a.symbol === symbol)) { alert('D√©j√† dans la surveillance.'); return; }
  watchlist.push({ symbol, type: 'action', name, reason: 'Sugg√©r√© par IA', date: new Date().toLocaleDateString('fr-CH'), id: Date.now() });
  saveAllData(); renderWatchlist(); fetchPricesFor([symbol]);
  alert(symbol + ' ajout√© √† la surveillance !');
}

// AI CHAT
function buildContext() {
  const c = getConfig();
  const pd = portfolio.map(a => {
    const price = prices[a.symbol];
    const cp = price ? getPriceInCHF(a.symbol, price.c).toFixed(4)+' CHF' : 'N/A';
    const pct = price ? (((getPriceInCHF(a.symbol,price.c)-a.buyPrice)/a.buyPrice)*100).toFixed(2)+'%' : 'N/A';
    return `- ${a.symbol} (${a.name}): ${a.qty} unit√©s, achat ${a.buyPrice} CHF, actuel ${cp}, P&L: ${pct}`;
  }).join('\n') || 'Vide';
  const wd = watchlist.map(a => { const p = prices[a.symbol]; return `- ${a.symbol}: ${p ? getPriceInCHF(a.symbol,p.c).toFixed(4)+' CHF' : 'N/A'}`; }).join('\n') || 'Aucun';
  const marketCtx = lastMarketContext ? `\nCONTEXTE MARCH√â ACTUEL:\n${lastMarketContext}\n` : '';
  return `Conseiller financier expert, fran√ßais. Profil: ${c.riskProfile}, budget: ${c.monthlyBudget} ${c.currency}/mois, horizon: ${c.horizon}, courtier: ${c.broker}, frais: ${c.fixedFees} CHF + ${c.varFees}%, change: ${c.fxFees}%, objectif: ${c.objective}.
1 USD = ${fxRates.USDCHF.toFixed(4)} CHF.${marketCtx}
PORTEFEUILLE:\n${pd}\nSURVEILLANCE:\n${wd}`;
}

async function askQuestion() {
  const { anthropicKey } = getConfig();
  if (!anthropicKey) { alert('Cl√© API Anthropic manquante.'); return; }
  const input = document.getElementById('aiQuestion'), q = input.value.trim();
  if (!q) return;
  const result = document.getElementById('aiResult');
  result.classList.remove('placeholder');
  result.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> Claude r√©fl√©chit‚Ä¶';
  input.value = '';
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': anthropicKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({ model: 'claude-sonnet-4-6', max_tokens: 1000, messages: [{ role: 'user', content: buildContext() + '\n\nQUESTION: ' + q + '\n\nR√©ponds en fran√ßais, de fa√ßon concise et pratique.' }] })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    const answer = data.content[0].text;
    result.textContent = answer;
    history.unshift({ date: new Date().toLocaleString('fr-CH'), question: q, answer });
    if (history.length > 10) history.pop();
    saveAllData(); renderHistory();
  } catch(e) { result.textContent = '‚ö†Ô∏è Erreur: ' + e.message; }
}

function renderHistory() {
  const list = document.getElementById('historyList'), section = document.getElementById('historySection');
  if (!history.length) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  list.innerHTML = history.map(h => `<div class="history-item"><div class="h-date">${h.date}</div><div class="h-q">‚ùì ${h.question}</div><div class="h-a">${h.answer}</div></div>`).join('');
}

function clearHistory() { history = []; saveAllData(); renderHistory(); }

// INIT
async function init() {
  document.getElementById('lastUpdate').textContent = 'Chargement‚Ä¶';
  await loadAllData();
  checkSettingsBanner();
  loadSettingsForm();
  renderPortfolio();
  renderWatchlist();
  renderOpportunities();
  renderHistory();
  await fetchFxRates();
  await refreshPrices();
  // Lancer le briefing march√© automatiquement si cl√© API disponible
  const { anthropicKey } = getConfig();
  if (anthropicKey) fetchMarketNews(true);
}

init();
</script>
</body>
</html>
